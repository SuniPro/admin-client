name: Eslint

on: pull_request

permissions:
  contents: read
  pull-requests: write  # âœ… PR ì½”ë©˜íŠ¸ ì‘ì„± ê¶Œí•œ ì¶”ê°€

jobs:
  eslint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install dependencies
        run: npm ci

      - name: Install reviewdog
        run: |
          curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh | sh -s -- -b /usr/local/bin

      - name: Debug ESLint Execution
        run: |
          echo "ğŸ“Œ Checking ESLint Config File..."
          ls -la eslint.config.js || echo "eslint.config.js íŒŒì¼ì´ ì—†ìŒ"
          
          echo "ğŸ“Œ Checking TypeScript Config File..."
          ls -la tsconfig.app.json || echo "tsconfig.app.json íŒŒì¼ì´ ì—†ìŒ"
          
          echo "ğŸ“Œ Running ESLint with Debug Mode..."
          npx eslint . --config eslint.config.js --debug || echo "âŒ ESLint ì‹¤í–‰ ì‹¤íŒ¨"


      - name: Run ESLint and report with reviewdog
        run: |
          npx eslint . --config eslint.config.js --format=json > eslint-report.json || true
          echo "ğŸ“Œ ESLint JSON Output:"
          cat eslint-report.json  # âœ… JSON ê²°ê³¼ ì¶œë ¥
          
          cat eslint-report.json | jq -c '.[] | select(.messages != []) | {filePath, messages}' > eslint-compact.json
          
          echo "ğŸ“Œ Processed ESLint Output:"
          cat eslint-compact.json  # âœ… ë³€í™˜ëœ JSON ê²°ê³¼ ì¶œë ¥

          # reviewdog ì‹¤í–‰
          cat eslint-compact.json | reviewdog -efm="%f: %l:%c: %m" -name="ESLint" -reporter=github-pr-review -level=error

          # âŒ ESLint ì˜¤ë¥˜ê°€ ìˆëŠ” ê²½ìš°ë§Œ CI ì‹¤íŒ¨
          if [ -s eslint-compact.json ]; then
            echo "âŒ ESLint ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. CI ì‹¤íŒ¨"
            exit 1
          fi
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment Security Issues on PR
        if: always()  # âœ… ESLint ê²€ì‚¬ í›„ í•­ìƒ ì‹¤í–‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              console.log("PRì´ ì•„ë‹™ë‹ˆë‹¤. ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
              return;
            }

            const fs = require("fs");

            let securityReport = [];
            try {
              if (fs.existsSync("eslint-compact.json") && fs.statSync("eslint-compact.json").size > 0) {
                const fileContent = fs.readFileSync("eslint-compact.json", "utf8").trim();
                securityReport = JSON.parse(fileContent);
              } else {
                console.log("âš ï¸ eslint-compact.json íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
              }
            } catch (error) {
              console.error("âŒ eslint-compact.jsonì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }

            // âœ… ë³´ì•ˆ ì·¨ì•½ì ì´ ìˆëŠ” íŒŒì¼ë§Œ í•„í„°ë§
            const securityIssues = securityReport.filter(file => file.messages && file.messages.length > 0);

            if (securityIssues.length > 0) {
              let message = `ğŸš¨ **ESLint Security ë¶„ì„ ê²°ê³¼** ğŸš¨\n\n`;
              message += `âš ï¸ **${securityIssues.length}ê°œì˜ ë³´ì•ˆ ì·¨ì•½ì **ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
              message += `ğŸ” ìì„¸í•œ ë‚´ìš©ì€ GitHub Actions ë¡œê·¸ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\n\n`;

              for (const issue of securityIssues.slice(0, 5)) {  // âœ… ì—¬ê¸°ì„œ `#`ì„ `//`ìœ¼ë¡œ ë³€ê²½
                const filePath = issue.filePath.replace('/home/runner/work/', '');
                const firstMessage = issue.messages[0];
                message += `- **${firstMessage.ruleId || "ë³´ì•ˆ ë¬¸ì œ"}** (íŒŒì¼: \`${filePath}\`): ${firstMessage.message}\n`;
              }

              await github.pulls.createReview({
                owner,
                repo,
                pull_number: prNumber,
                event: "COMMENT",
                body: message
              });

              console.log("ğŸš€ PRì— ë³´ì•ˆ ì·¨ì•½ì  ê²½ê³  ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
            } else {
              console.log("âœ… ë³´ì•ˆ ì·¨ì•½ì  ì—†ìŒ. PR ì½”ë©˜íŠ¸ ìƒëµ.");
            }
