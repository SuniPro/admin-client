name: "CodeQL Analysis for React 19 + Vite"

on: pull_request  # âœ… PR ìƒì„± ì‹œ CodeQL ì‹¤í–‰

jobs:
  analyze:
    name: "CodeQL Analysis"
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      pull-requests: write  # âœ… PRì— ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê¸°ê¸° ìœ„í•´ í•„ìš”
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: [javascript, typescript]  # âœ… TypeScript ì½”ë“œë§Œ ë¶„ì„

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # âœ… ìµœì‹  Node.js ë²„ì „ ì‚¬ìš©

      - name: Install dependencies
        run: npm ci  # âœ… CodeQL ì‹¤í–‰ì„ ìœ„í•œ ì˜ì¡´ì„± ì„¤ì¹˜

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
          paths-ignore: |
            node_modules/
            dist/  # âœ… Vite ë¹Œë“œ ê²°ê³¼ë¬¼ ì œì™¸

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Post CodeQL Results as PR Comment
        if: always()  # âœ… CodeQL ì‹¤í–‰ í›„ í•­ìƒ ì‹¤í–‰
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              console.log("PRì´ ì•„ë‹™ë‹ˆë‹¤. ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
              return;
            }

            const alerts = await github.request('GET /repos/{owner}/{repo}/code-scanning/alerts', {
              owner: owner,
              repo: repo
            });

            if (alerts.data.length > 0) {
              let message = `ğŸš¨ **CodeQL ë¶„ì„ ê²°ê³¼** ğŸš¨\n\n`;
              message += `âš ï¸ **${alerts.data.length}ê°œì˜ ë³´ì•ˆ ì·¨ì•½ì **ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n`;
              message += `ğŸ” [Code Scanning Alerts](https://github.com/${owner}/${repo}/security/code-scanning)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\n\n`;

              for (const alert of alerts.data.slice(0, 5)) {  // ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ í‘œì‹œ
                message += `- **${alert.rule.description}** (íŒŒì¼: \`${alert.most_recent_instance.location.file}\`)\n`;
              }

              await github.pulls.createReview({
                owner,
                repo,
                pull_number: prNumber,
                event: "COMMENT",
                body: message
              });

              console.log("ğŸš€ PRì— CodeQL ë¶„ì„ ê²°ê³¼ ì½”ë©˜íŠ¸ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
            } else {
              console.log("âœ… CodeQL ë¶„ì„ ê²°ê³¼ ë¬¸ì œ ì—†ìŒ. PRì— ì½”ë©˜íŠ¸ ì¶”ê°€í•˜ì§€ ì•ŠìŒ.");
            }
