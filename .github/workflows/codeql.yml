name: "CodeQL Analysis for React 19 + Vite"

on: pull_request  # ✅ PR 생성 시 CodeQL 실행

jobs:
  analyze:
    name: "CodeQL Analysis"
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      pull-requests: write  # ✅ PR에 코멘트를 남기기 위해 필요
      actions: read
      contents: read

    strategy:
      fail-fast: false
      matrix:
        language: [javascript, typescript]  # ✅ TypeScript 코드만 분석

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x  # ✅ 최신 Node.js 버전 사용

      - name: Install dependencies
        run: npm ci  # ✅ CodeQL 실행을 위한 의존성 설치

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
          paths-ignore: |
            node_modules/
            dist/  # ✅ Vite 빌드 결과물 제외

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Post CodeQL Results as PR Comment
        if: always()  # ✅ CodeQL 실행 후 항상 실행
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request?.number;

            if (!prNumber) {
              console.log("PR이 아닙니다. 코멘트를 추가하지 않습니다.");
              return;
            }

            const alerts = await github.request('GET /repos/{owner}/{repo}/code-scanning/alerts', {
              owner: owner,
              repo: repo
            });

            if (alerts.data.length > 0) {
              let message = `🚨 **CodeQL 분석 결과** 🚨\n\n`;
              message += `⚠️ **${alerts.data.length}개의 보안 취약점**이 발견되었습니다.\n`;
              message += `🔍 [Code Scanning Alerts](https://github.com/${owner}/${repo}/security/code-scanning)에서 확인하세요.\n\n`;

              for (const alert of alerts.data.slice(0, 5)) {  // 최대 5개까지만 표시
                message += `- **${alert.rule.description}** (파일: \`${alert.most_recent_instance.location.file}\`)\n`;
              }

              await github.pulls.createReview({
                owner,
                repo,
                pull_number: prNumber,
                event: "COMMENT",
                body: message
              });

              console.log("🚀 PR에 CodeQL 분석 결과 코멘트를 추가했습니다.");
            } else {
              console.log("✅ CodeQL 분석 결과 문제 없음. PR에 코멘트 추가하지 않음.");
            }
